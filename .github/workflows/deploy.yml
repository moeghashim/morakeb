name: Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DEPLOY_SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST }}
      DEPLOY_SSH_USER: ${{ secrets.DEPLOY_SSH_USER }}
      DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
      DEPLOY_SSH_ALIAS: ${{ vars.DEPLOY_SSH_ALIAS || 'changes' }}
      DEPLOY_SSH_PORT: ${{ vars.DEPLOY_SSH_PORT || '' }}
      DEPLOY_PATH: ${{ vars.DEPLOY_PATH || '/opt/changes' }}
      DEPLOY_NOTIFY: ${{ vars.DEPLOY_NOTIFY || 'true' }}
    if: ${{ vars.DEPLOY_ENABLED == 'true' }}
    
    steps:
    - uses: actions/checkout@v4

    - name: Check required secrets
      run: |
        if [ -z "${DEPLOY_SSH_HOST}" ] || [ -z "${DEPLOY_SSH_USER}" ] || [ -z "${DEPLOY_SSH_KEY}" ]; then
          echo "Missing deploy secrets. Set DEPLOY_SSH_HOST, DEPLOY_SSH_USER, DEPLOY_SSH_KEY."
          exit 1
        fi

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        cat > ~/.ssh/config <<EOF
        Host ${DEPLOY_SSH_ALIAS}
          HostName ${DEPLOY_SSH_HOST}
          User ${DEPLOY_SSH_USER}
          IdentityFile ~/.ssh/deploy_key
          StrictHostKeyChecking accept-new
          ServerAliveInterval 30
          ServerAliveCountMax 3
        EOF
        if [ -n "${DEPLOY_SSH_PORT}" ]; then
          echo "  Port ${DEPLOY_SSH_PORT}" >> ~/.ssh/config
        fi
        chmod 600 ~/.ssh/config
        echo "${DEPLOY_SSH_KEY}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
    
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    
    - name: Install dependencies
      run: bun install
    
    - name: Notify deploy start (remote)
      if: env.DEPLOY_NOTIFY == 'true'
      run: |
        ssh "${DEPLOY_SSH_ALIAS}" "bash -lc \"cd ${DEPLOY_PATH} && if [ -f scripts/notify.ts ]; then GITHUB_REPOSITORY='${{ github.repository }}' GITHUB_REF_NAME='${{ github.ref_name }}' GITHUB_SHA='${{ github.sha }}' GITHUB_ACTOR='${{ github.actor }}' GITHUB_RUN_ID='${{ github.run_id }}' GITHUB_SERVER_URL='${{ github.server_url }}' \\\"$HOME/.bun/bin/bun\\\" scripts/notify.ts deploy start; else echo 'notify.ts missing (likely first deploy); skipping start notify'; fi\""
    
    - name: Deploy to VPS
      run: bun run deploy --host "${DEPLOY_SSH_ALIAS}" --dest "${DEPLOY_PATH}"

    - name: Notify deploy success (remote)
      if: success() && env.DEPLOY_NOTIFY == 'true'
      run: |
        ssh "${DEPLOY_SSH_ALIAS}" "bash -lc \"cd ${DEPLOY_PATH} && if [ -f scripts/notify.ts ]; then GITHUB_REPOSITORY='${{ github.repository }}' GITHUB_REF_NAME='${{ github.ref_name }}' GITHUB_SHA='${{ github.sha }}' GITHUB_ACTOR='${{ github.actor }}' GITHUB_RUN_ID='${{ github.run_id }}' GITHUB_SERVER_URL='${{ github.server_url }}' \\\"$HOME/.bun/bin/bun\\\" scripts/notify.ts deploy success; else echo 'notify.ts missing; skipping success notify'; fi\""

    - name: Notify deploy failure (remote)
      if: failure() && env.DEPLOY_NOTIFY == 'true'
      run: |
        ssh "${DEPLOY_SSH_ALIAS}" "bash -lc \"cd ${DEPLOY_PATH} && if [ -f scripts/notify.ts ]; then GITHUB_REPOSITORY='${{ github.repository }}' GITHUB_REF_NAME='${{ github.ref_name }}' GITHUB_SHA='${{ github.sha }}' GITHUB_ACTOR='${{ github.actor }}' GITHUB_RUN_ID='${{ github.run_id }}' GITHUB_SERVER_URL='${{ github.server_url }}' \\\"$HOME/.bun/bin/bun\\\" scripts/notify.ts deploy failure --message 'See run for details'; else echo 'notify.ts missing; skipping failure notify'; fi\""
